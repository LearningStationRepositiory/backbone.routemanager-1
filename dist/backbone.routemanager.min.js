/*!
 * backbone.routemanager.js v0.1.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.routemanager.js may be freely distributed underthe MIT license.
 */
(function(a){function b(a,b,c){var d=-1,e=a.length>>>0;(function f(g){var h,j=g===!1;do++d;while(!(d in a)&&d!==e);if(j||d===e){c&&c(!j,a);return}g=b.call({async:function(){return h=!0,f}},a[d],d,a),h||f(g)})()}function c(a,c){function l(a){var b=j.deferred();return b.async=function(){return b._isAsync=!0,a},b.defer=function(){b._isDefer=!0;var a=j.deferred();return l._bucket.push(a),a},b}function m(a){var b,c,d=[],e=a.toString().match(/function\s+\(([^)]*)\)/)[1].split(", ");for(b=0;b<e.length;b++)c=e[b],(c=c.replace(/\/\*.*\*\//,""))&&d.push(c.replace(/^\s+|\s+$/g,""));return d}function n(a,b){var c=h[0],d=e.chain(c[a]);g[a]=g[a]||[],d.filter(function(a,c){return b+"/"+c===f}),d=e.reduce(d.value(),function(a,b){return a.concat(b)},[]),d=e.map(d,function(a){var b,c;return e.find(h,function(d){if(e.isFunction(d[a]))return b=d,c=d[a]}),e.isFunction(c)||(c=function(){}),[b,c]}),g[a]=g[a].concat(d)}function o(a){var b=a.__manager__.prefix;h.unshift(a),n("before",b),n("after",b),a.routers&&e.each(a.routers,function(a){return o(a)})}var f,g=[],h=[],i=this,j=i.options,k=e.map(c.match(/:(\w+)|\*(\w+)/g),function(a){return a.slice(1)});return l._bucket=[],function(){var c=arguments,i=this;f=d.history.fragment,this.params={},e.each(k,function(a,b){this.params[a]=c[b]},this),o(i),b(g.before,function(b){var c,d,f=[],g=this.async();c=l(function(){g.apply(this,arguments)}),e.each(m(a),function(a,b){f[b]=i.params[a]}),d=b[1].apply(b[0],f);if(!c.isDefer&&l._bucket.length){j.when(l._bucket).always(function(){l._bucket.splice(0,l._bucket.length),c._isAsync||g(d)});return}c.isDefer?c._bucket.push(d):g(d)},function(){a.apply(i,c),e.each(g.after,function(b){var c=[];e.each(m(a),function(a,b){c[b]=i.params[a]}),b[1].apply(b[0],c)}),h=[],g=[]})}}"use strict";var d=a.Backbone,e=a._,f=a.$,g=d.Router.extend({constructor:function(a){var b=this,f={},g=this.routers={},h=a.routes||this.routes;return e.each(h,function(h,i){var j,k,l,m,n;j=a.prefix,j||(j=i||""),j[j.length-1]==="/"?j=j.slice(0,j.length-1):j&&(j+="/");if(h.prototype instanceof d.Router)k=h.prototype.constructor,m=h.extend({constructor:function(a){var b=d.Router.prototype.constructor;return e.each(this.routes,function(a,b){delete this.routes[b],b=b?j+"/"+b:j,this.routes[b]=a,this[a]=c.call(this,this[a],b)},this),b.apply(this,arguments)},options:d.RouteManager.prototype.options}),l=g[i]=new m,i._state={},l.__manager__={},e.isFunction(k)&&k.call(l),l.__manager__.prefix=j;else if(e.isString(h)&&e.isString(i)){j=a.prefix?a.prefix:"",b[h]=c.call(b,a[h],i),delete a[h];if(i)return f[j+i]=h;f[j]=h}}),this.routes=f,d.Router.prototype.constructor.call(this)},__manager__:{prefix:""}},{configure:function(a){var b=d.RouteManager.prototype.options;if(e.isObject(a))return e.extend(b,a)}});g.prototype.options={deferred:function(){return f.Deferred()},when:function(a){return f.when.apply(null,a)}},d.RouteManager=g})(this)