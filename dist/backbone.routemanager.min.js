/*!
 * backbone.routemanager.js v0.1.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.routemanager.js may be freely distributed underthe MIT license.
 */
(function(a){function b(a,b,c){var d=-1,e=a.length>>>0;(function f(g){var h,j=g===!1;do++d;while(!(d in a)&&d!==e);if(j||d===e){c&&c(!j,a);return}g=b.call({async:function(){return h=!0,f}},a[d],d,a),h||f(g)})()}function c(a,c){function l(a){var b=j.deferred();return b.async=function(){return b._isAsync=!0,a},b.defer=function(a){return b._isDefer=!0,a=a||j.deferred(),l._bucket.push(a),a},b._done=a,b}function m(a,b){var c=h[0],d=e.chain(c[a]);g[a]=g[a]||[],d=d.filter(function(a,c){return c?[b,c].join("/"):b===f}),d=e.reduce(d.value(),function(a,b){return a.concat(b)},[]),d=e.map(d,function(a){var b,c;return e.find(h,function(d){if(e.isFunction(d[a]))return b=d,c=d[a]}),e.isFunction(c)||(c=function(){}),[b,c]}),g[a]=g[a].concat(d)}function n(a){var b=a.__manager__.prefix;h.unshift(a),m("before",b),m("after",b),a.routers&&e.each(a.routers,function(a){return n(a)})}var f,g=[],h=[],i=this,j=i.options,k=e.map(c.match(/:(\w+)|\*(\w+)/g),function(a){return a.slice(1)});return l._bucket=[],function(){var c=arguments,i=this.router?this.router:this;f=d.history.fragment,this.params={},e.each(k,function(a,b){this.params[a]=c[b]},this),n(i.__manager__.root||i),b(g.before,function(a){var b,c,d=[],e=this.async();b=l(function(){e.apply(this,arguments)}),b.router=i,c=a[1].apply(b,d);if(!b.isDefer&&l._bucket.length){j.when(l._bucket).always(function(){l._bucket.splice(0,l._bucket.length),b._isAsync||e(c)});return}b.isDefer?b._bucket.push(c):e(c)},function(){var b=l(function(){e.each(g.after,function(a){a[1].call(a[0])}),h=[],g=[]});b.router=i,e.isFunction(a)&&a.apply(b,c),b._isAsync||b._done()})}}"use strict";var d=a.Backbone,e=a._,f=a.$,g=d.Router.extend({constructor:function(a){a=a||this;var b=this,f={},g=this.routers={},h=a.routes;return e.each(h,function(h,i){var j,k,l,m,n=a.prefix;n||(n=i||""),n[n.length-1]==="/"?n=n.slice(0,n.length-1):n&&(n+="/");if(h.prototype instanceof d.Router)j=h.prototype.constructor,l=h.extend({constructor:function(a){var b=d.Router.prototype.constructor;return e.each(this.routes,function(a,b){delete this.routes[b],b=b?n+"/"+b:n,this.routes[b]=a,this[a]=c.call(this,this[a],b)},this),b.apply(this,arguments)},options:d.RouteManager.prototype.options}),k=g[i]=new l,i._state={},k.__manager__={prefix:n,root:b},e.isFunction(j)&&j.call(k);else if(e.isString(h)&&e.isString(i)){n=a.prefix?a.prefix:"",b[h]=c.call(b,a[h],i),a!==b&&delete a[h];if(i)return f[n+i]=h;f[n]=h}}),this.routes=f,d.Router.prototype.constructor.call(this)},__manager__:{prefix:""}},{configure:function(a){var b=d.RouteManager.prototype.options;if(e.isObject(a))return e.extend(b,a)}});g.prototype.options={deferred:function(){return f.Deferred()},when:function(a){return f.when.apply(null,a)}},d.RouteManager=g})(this)